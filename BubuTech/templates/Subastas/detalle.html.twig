{% extends 'base.html.twig' %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('css/detalle_subasta.css') }}">
{% endblock %}

{% block body %}
<main class="detalle-container">
    <h2 class="title">Detalle de la Subasta</h2>

    <div class="detalle-card">
        <div class="detalle-imagen">
            {% if subasta.producto.imagen %}
                <img src="{{ asset('uploads/productos/' ~ subasta.producto.imagen) }}" alt="{{ subasta.producto.nombre }}">
            {% else %}
                <img src="{{ asset('img/no-image.png') }}" alt="Sin imagen">
            {% endif %}
        </div>

        <div class="detalle-info">
            {# Mensajes flash #}
            {% for message in app.flashes('success') %}
                <div class="flash-success">{{ message }}</div>
            {% endfor %}
            {% for message in app.flashes('error') %}
                <div class="flash-error">{{ message }}</div>
            {% endfor %}
            <h3>{{ subasta.producto.nombre }}</h3>
            <p><strong>Descripci√≥n:</strong> {{ subasta.producto.descripcion }}</p>
            <p><strong>Precio Inicial:</strong> ${{ subasta.precioBase }}</p>
            <p><strong>Estado:</strong> {{ subasta.estado.value }}</p>
            
            {% if subasta.estado.value == 'activa' and usuario is not same as(subasta.vendedor) %}
                <p><strong>Finaliza:</strong> {{ subasta.duracion|date('d/m/Y H:i') }}</p>
                {% if subasta.OfertaParcialGanadora == 0 %}
                    <p><strong>¬°S√© la primer Oferta!</strong></p>
                {% else %}
                    <p><strong>Oferta Ganadora Hasta el Momento:</strong> {{ subasta.OfertaParcialGanadora }}$</p>
                {% endif %}
                <div class="oferta-seccion">
                <h4>Realizar una oferta</h4>
                <form method="post">
                    <input type="number" name="monto" step="0.01" min="1" required>
                    <button type="submit" class="btn-ofertar">Ofertar</button>
                </form>
                </div>
            {% elseif subasta.estado.value == 'activa' and usuario is same as(subasta.vendedor) %}
                <p><strong>Finaliza:</strong> {{ subasta.duracion|date('d/m/Y H:i') }}</p>
                {% if subasta.OfertaParcialGanadora == 0 %}
                    <p><strong>Sin Ofertas A√∫n</strong></p>
                {% else %}
                    <p><strong>Oferta Ganadora Hasta el Momento:</strong> {{ subasta.OfertaParcialGanadora }}$</p>
                {% endif %}
            {% endif %}
            {% if subasta.estado.value == 'finalizada' %}
                <p><strong>Oferta Ganadora:</strong> {{ subasta.OfertaFinalGanadora }}$</p>
                <p><strong>Ganador(a):</strong> {{ subasta.ganador.NombreUsuario }}</p>
                <p><strong>Historial de Ofertas:</strong></p>
                <div class="historial-ofertas">
                    {% for oferta in subasta.oferta %}
                        <p><strong>Usuario:</strong> {{ oferta.ofertante.NombreUsuario }}</p>
                        <p><strong>Monto Ofertado:</strong> {{ oferta.monto }}$</p>
                        <p><strong>----------------</strong></p>
                    {% endfor %}
                </div>
                
            {% endif %}

            <a href="{{ path('listar_subastas') }}" class="btn-volver">‚Üê Volver a la lista</a>
        </div>
    
    <div class="comentarios-seccion">
        <h4>Comentarios</h4>

        <form method="post">
            <textarea name="comentario" rows="3" required></textarea>
            <button type="submit" class="btn-comentar">Comentar</button>
        </form>

        {% for message in app.flashes('success-coment') %}
                <div class="flash-success" style="margin-bottom: 5%;">{{ message }}</div>
        {% endfor %}
        {% for message in app.flashes('info') %}
                <div class="flash-success">{{ message }}</div>
        {% endfor %}

        <ul class="lista-comentarios">
            {% for comentario in comentarios %}
                <li>
                    <strong>{{ comentario.comentador.nombreUsuario }}</strong>
                    <small>{{ comentario.fecha|date('d/m/Y H:i') }}</small>
                    <p>{{ comentario.detalle }}</p>
                    <a href="{{ path('likear', { id: subasta.id, id_com: comentario.id }) }}" style="text-decoration: none;">
                        <span>üëç {{ comentario.cantidadLikes }}</span>
                    </a>
                {% if usuario is same as(subasta.vendedor) or usuario is same as(comentario.comentador) %}
                    <a href="{{ path('eliminar_comentario', { id: subasta.id, id_com: comentario.id }) }}" style="text-decoration: none;">
                        <span style="float: right;">‚ùå Eliminar</span>
                    </a>
                {% endif %}
                </li>
            {% else %}
                <li>No hay comentarios a√∫n</li>
            {% endfor %}
        </ul>
    </div>
</main>

{% endblock %}
